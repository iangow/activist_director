\documentclass[titlepage,12pt]{article} % scrartcl

% for \doublespacing
\usepackage{setspace}
\usepackage{titlesec}
\titleformat{\section}
  {\normalfont\bfseries}{\thesection.}{1em}{}

\titleformat{\subsection}
  {\normalfont\itshape}{\thesubsection.}{1em}{}

%\documentclass[11pt]{amsart} % Perhaps use article
%\usepackage[backend=bibtex]{bibtex}
\usepackage{rotating}
\usepackage{pdflscape}
\usepackage{array}
\usepackage{booktabs}
\usepackage{dcolumn}
\usepackage{palatino}
\usepackage{tabularx}

\usepackage{natbib}
\usepackage[marginratio=1:1]{geometry}  % See geometry.pdf to learn the layout options. There are lots.
\geometry{margin=0.8in}
%\geometry{letterpaper} % ... or a4paper or a5paper or ...

\setlength{\parindent}{4em}
% Paragraphs begin with empty line plus indent
\edef\restoreparindent{\parindent=\the\parindent\relax}
\usepackage{parskip}
\restoreparindent

\usepackage{paralist}
\usepackage{dcolumn}
\usepackage[hidelinks]{hyperref}

\newcolumntype{Y}{>{\raggedleft\arraybackslash}X}% raggedleft column X
\hypersetup{colorlinks=false}

\mathchardef\mhyphen="2D

\begin{document}

\bibliographystyle{kluwer} % , chicago, kluwer

<<check_pg, cache=FALSE, include=FALSE>>=
readRenviron(".Renviron")
library(dplyr, warn.conflicts = FALSE)
library(DBI)

getComment <- function(table, schema) {
    pg <- dbConnect(RPostgreSQL::PostgreSQL())

    sql = sprintf("
        SELECT description
        FROM pg_description
        JOIN pg_class
        ON pg_description.objoid = pg_class.oid
        JOIN pg_namespace
        ON pg_class.relnamespace = pg_namespace.oid
        WHERE relname = '%s' AND nspname='%s'", table, schema)

    res <-
        dbGetQuery(pg, sql) %>%
        dplyr::select(description) %>%
        dplyr::pull()

    dbDisconnect(pg)
    return(res)
}

events.updated <- getComment("activism_events", "activist_director")
holdings.updated <- getComment("activist_holdings", "activist_director")
@

% This code gets statistics to refer to in the document.
\Sexpr{opts_chunk$set(cache.extra=events.updated)}
<<sample_stats, cache=TRUE, include=FALSE>>=
# PostgreSQL Connection
pg <- dbConnect(RPostgreSQL::PostgreSQL())

dbExecute(pg, "SET search_path TO activist_director")

activism_events <- tbl(pg, "activism_events")
activist_directors <- tbl(pg, "activist_directors")
activist_ciks <- tbl(pg, sql("SELECT * FROM factset.activist_ciks"))

events <-
    activism_events %>%
    mutate(year = date_part('year', eff_announce_date)) %>%
    select(permno, year, category) %>%
    collect()

ad_years <-
    activism_events %>%
    mutate(campaign_id = unnest(campaign_ids)) %>%
    group_by(campaign_id) %>%
    summarize(elected = bool_or(elected)) %>%
    inner_join(activist_directors, by = "campaign_id") %>%
    mutate(year = date_part('year', eff_announce_date)) %>%
    filter(!is.na(appointment_date), !is.na(permno), !is.na(independent))

dirs <-
    ad_years %>%
    summarize(all_dirs = n(),
              affiliated = sum(as.integer(!independent), na.rm = TRUE),
              unaffiliated = sum(as.integer(independent), na.rm = TRUE),
              settled = sum(as.integer(!elected), na.rm = TRUE),
              elected = sum(as.integer(elected), na.rm = TRUE)) %>%
    collect()

num_events <- formatC(nrow(events), big.mark = ",")
num_uniq_events <- formatC(nrow(unique(events)), big.mark = ",")
act_dir <- formatC(sum(events$category=="activist_director"), big.mark = ",")
brd_dmd <- formatC(sum(events$category=="activist_demand"), big.mark = ",")
act_only <- formatC(sum(events$category=="activism"), big.mark = ",")
percent_aff <- formatC(100*dirs$affiliated/dirs$all_dirs, format="f", digits=0)

# Stats on 13F filers
events_w_cik <-
    activism_events %>%
    mutate(activist_name = unnest(dissidents)) %>%
    left_join(activist_ciks, by = "activist_name") %>%
    group_by(campaign_id) %>%
    summarize(has_cik = bool_or(!is.na(cik))) %>%
    ungroup()

filers <-
    events_w_cik %>%
    summarize(num_13f = sum(as.integer(has_cik), na.rm = TRUE),
              perc_13f = mean(as.integer(has_cik), na.rm = TRUE)) %>%
    collect()

num_13f <- formatC(filers$num_13f, big.mark = ",")
perc_13f <- formatC(100*filers$perc_13f, format="f", digits=2)
@
\Sexpr{opts_chunk$set(cache.extra=NULL)}

<<introduction, child='intro.Rnw'>>=
@

<<lit_review, child='literature_review.Rnw'>>=
@

<<sample_desc, child='sample_desc.Rnw'>>=
@

<<results, child='results.Rnw'>>=
@

<<conclusion, child='conclusion.Rnw'>>=
@
\newpage

\bibliography{papers}

\newpage
<<table_desc, child='tables/table_desc.Rnw'>>=
@

<<table_dir_desc, child='tables/table_dir_desc.Rnw'>>=
@

<<table_voting, child='tables/table_voting.Rnw'>>=
@

<<table_career, child='tables/table_career.Rnw'>>=
@

<<table_selection, child='tables/table_selection.Rnw'>>=
@

<<table_holding_period, child='tables/table_holding_period.Rnw'>>=
@

<<table_returns, child='tables/table_returns.Rnw'>>=
@

<<roa_table, child='tables/roa_table.Rnw'>>=
@

<<table_outcomes_x, child='tables/table_outcomes_x.Rnw'>>=
@

\end{document}
